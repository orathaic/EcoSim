<!doctype html>
<style>
:root {background:#111;color:#eee;white-space:pre}
/*#Canvas {height: 100%; width: 100%}*/
</style>
<script src="Creature.js"></script>
<script>
"use strict";

var mainNeighbourhood = []
var n,m, pixelsPerCommunity
n = m = 4
pixelsPerCommunity = 800/n;
//mainNeighbourhood[0] = new Community(0.5,0.5, mainNeighbourhood);

for(var i = 0; i < n; i++){
	for(var j = 0; j < m; j++){

		mainNeighbourhood[(i*n+j)] = new Community(i,j,mainNeighbourhood, pixelsPerCommunity) 
	}
}
/*
for (var i = 0; i < 7; i++) {
    new Plant(
        mainNeighbourhood[0]
       	//,['red','green','blue'][Math.floor(Math.random()*3)]
		,'green'
       	,Math.floor(pixelsPerCommunity*Math.random())
       	,Math.floor(pixelsPerCommunity*Math.random())
    )
}
*/
for (var i = 0; i < 2; i++) {
    new Plant(
        mainNeighbourhood[3]
       	//,['red','green','blue'][Math.floor(Math.random()*3)]
		,'green'
       	,Math.floor(pixelsPerCommunity*Math.random())+pixelsPerCommunity
       	,Math.floor(pixelsPerCommunity*Math.random())+pixelsPerCommunity
    )
}


var Canvas = {};
Canvas.Neighbourhood = mainNeighbourhood;

Canvas.redraw = function (Creatures) {
//	if(this.reDraw)
	
	var c = document.getElementById("Canvas");
	var ctx = c.getContext("2d");
//	ctx.clearRect(0, 0, c.width, c.height);
		for(var i =0, l =Creatures.length; i < l; i++)
		 { // Draw loop
			Creature = Creatures[i];
			ctx.beginPath();
			ctx.arc(Creature.x,Creature.y,Math.max(Creature.energy,1)/20,0,6.283185307179586); // 6.283185307179586 is 2 * Math.PI 
			ctx.fillStyle = Creature.type;
			ctx.fill();
		 }
//		requestAnimationFrame(this.redraw(this.Community.getCreatures() ) );
//		this.reDraw = false;

}

Canvas.drawCommunity = function (community) {
	var c = document.getElementById("Canvas")
	var ctx = c.getContext("2d")
	ctx.beginPath()
	ctx.moveTo(community.lowerBound,community.leftBound)
	ctx.lineTo(community.upperBound,community.leftBound)
	ctx.lineTo(community.upperBound,community.rightBound)
	ctx.lineTo(community.lowerBound,community.rightBound)
	ctx.lineTo(community.lowerBound,community.leftBound)
	ctx.strokeStyle = "Yellow"
	ctx.stroke()
}
Canvas.drawCommunities = function (neighbourhood) {
	for(var i = 0, l = neighbourhood.length; i < l; i++) {Canvas.drawCommunity(neighbourhood[i])}
}
Canvas.go = function () { 
	this.Interval = setInterval(() => {
    mainNeighbourhood.forEach(Community => Community.getCreatures().forEach(creature => creature.step()) ) 
	},1000/60)
	
//	this.reDraw = true;
/*	
	requestAnimationFrame(Canvas.redraw( mainCommunity.getCreatures() ));
*/
	this.ReDrawInterval = setInterval(() => {
			var c = document.getElementById("Canvas");
			var ctx = c.getContext("2d");
			ctx.clearRect(0, 0, c.width, c.height);

		 for(var i=0, l=mainNeighbourhood.length; i < l; i++) 
			{ Canvas.redraw( mainNeighbourhood[i].getCreatures()) }

//	    document.body.textContent = mainCommunity.Plants.concat(mainCommunity.Herbis).sort((aa,bb) => bb.energy - aa.energy).map(creature => creature.toString()).join('\n')
	},1000/60)
	this.Drawing = true 
}

Canvas.stop = function () { 
		clearInterval(this.Interval)
		clearInterval(this.ReDrawInterval)
	this.Drawing = false
}

Canvas.toggledraw = function () {
	if(Canvas.Drawing == undefined || Canvas.Drawing == false)
			Canvas.go()
		else Canvas.stop()
}

/*document.ontouchstart = function () { alert('touched')
	Canvas.toggledraw()
}*/

document.onkeypress = function () { 
		switch(event.which) { 
		case 103: Canvas.go(); break;
		case 115: Canvas.stop(); break;
		default:
		}
}

window.onload = function () {
	document.body.textContent = "Press (G)o to begin simulation \nAnd to (S)top or pause simulation\n"

	var Button = document.createElement("Button")
	Button.innerHTML = "Go"
	document.body.appendChild(Button)

	Button.addEventListener("click", Canvas.toggledraw)

	var C = document.createElement("Canvas")
	C.id = "Canvas"
	C.setAttribute("width", window.innerWidth);
	C.setAttribute("height", window.innerHeight);
	document.body.appendChild(C)
}
</script>

<!doctype html>
<style>
:root {background:#111;color:#eee;white-space:pre}
#Canvas {height: 100%; width: 100%; position:absolute; top:0; left:0}
</style>
<script src="Creature.js"></script>
<script>
"use strict";
var mainCommunity = new Community(150,150)

for (var i = 0; i < 7; i++) {
    new Plant(
        mainCommunity
       	//,['red','green','blue'][Math.floor(Math.random()*3)]
		,'green'
       	,Math.floor(250*Math.random())+50
       	,Math.floor(250*Math.random())+50
    )
}

var Canvas = {};
Canvas.Community = mainCommunity;
Canvas.Empty = function () {
	var that = document.getElementById('Canvas');
	while (that.firstChild) {
	  that.removeChild(that.firstChild);
	}
}

Canvas.Append = function (docFragment) {
	var that = document.getElementById('Canvas');
	that.appendChild(docFragment);
}

Canvas.redraw = function (Creatures) {
	if(this.reDraw)
	{
		var docFragment = document.createDocumentFragment();
		for(var i = 0, l = Creatures.length; i < l; i++)
		 { // Draw loop
			Creature = Creatures[i];
			var ToAdd = document.createElementNS("http://www.w3.org/2000/svg", "circle");;
			ToAdd.setAttribute("cx", Creature.x);
			ToAdd.setAttribute("cy", Creature.y);
			ToAdd.setAttribute("r", Math.max(Creature.energy,1)/20);
			ToAdd.setAttribute("fill", Creature.type);

			docFragment.appendChild(ToAdd);
		 }
		Canvas.Empty();
		Canvas.Append(docFragment);
//		requestAnimationFrame(this.redraw(this.Community.getCreatures() ) );
//		this.reDraw = false;
	}
}

Canvas.go = function () { 
	this.Interval = setInterval(() => {
    mainCommunity.getCreatures().forEach(creature => creature.step())
	},1000/60)
	
	this.reDraw = true;
/*	
	requestAnimationFrame(Canvas.redraw( mainCommunity.getCreatures() ));
*/
	this.ReDrawInterval = setInterval(() => { Canvas.redraw( mainCommunity.getCreatures() );
//	    document.body.textContent = mainCommunity.Plants.concat(mainCommunity.Herbis).sort((aa,bb) => bb.energy - aa.energy).map(creature => creature.toString()).join('\n')
	},1000/60) 
}

Canvas.stop = function () { 
		clearInterval(this.Interval)
		clearInterval(this.ReDrawInterval)

//		this.reDraw = false;
}

document.onkeypress = function (event) { 
		switch(event.which) { 
		case 103: Canvas.go(); break;
		case 115: Canvas.stop(); break;
		default:
		}
}

window.onload = function () {
	document.body.textContent = "Press (G)o to begin simulation \nAnd to (S)top or pause simulation"
	var C = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	C.id = "Canvas"
 	document.body.appendChild(C)
}
</script>
